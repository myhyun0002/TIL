# 3. 전세계의 DNS 서버가 연대한다.
## 1. DNS 서버의 기본 동작
___
앞에서는 리졸버와 DNS 서버의 대화를 배웠다
> 잠깐 정리        
>> 리졸버는 OS 안에 네트워크 기능을 애플리케이션에서 쓸 수 있도록 부품을 모아 놓은 **Socket** 라이브러리 안에 있다.       
>> 리졸버의 역할은 애플리케이션에서 (리졸버명,도메인명)으로 호출을 해서 호출을 받으면 DNS 서버에 보낼 리퀘스트 메시지를 만든다. (이 안에 도메인명 들어있음)         
그리고 리졸버는 송신 기능이 없으니 다시 OS에 가서 프로토콜 실행을 의뢰하여 DNS 서버에 리퀘스트 메시지를 보내고 DNS 서버는 해당 도메인명에 대한 IP주소를 다시 프로토콜 스택으로 보내고 프로토콜 스택은 리졸버로 보낸 다음 해당 응답 메시지에서 IP주소를 도출하여 애플리케이션 메모리에 저장한다.        

그럼 지금부터는 DNS 서버 동작을 배워보자.     
DNS 서버는 클라이언트에서 조회 메시지를 받고 응답해준다.
- 조회 메시지에는 3가지 정보가 포함되어 있다.
  - 이름 : ip 주소 또는 메일의 @ 뒤 주소
  - 클래스 
    - 처음에는 인터넷 이외에도 네트워크에서도 쓸려고 구분짓기 위해서 사용
    - 지금은 네트워크 기능 삭제 되어서
    - 인터넷인 **IN**으로 고정
  - 타입
    - 이름이 어떤 타입인지
      - 이름에 ip주소가 있으면 타입 A
      - 이름에 메일이 있으면 타입 MX      

해당 조회 메시지에 따라 응답 메시지를 작성한다.     
ex) 
- 조회 메시지
  - 이름 : www.lab.cyber.co.kr
  - 클래스 : IN (IN으로 고정)
  - 타입 : A     

DNS 서버는 위의 정보와 일치하는 것을 찾아서 응답 메시지에 담아 리졸버로 보낸다.

- 응답 메시지
  - 192.0.2.226   

타입의 종류는 다양하다. MX도 있고 PTR, CNAME, 등등이 있다.    
DNS는 이렇게 이름으로 정보를 구분하는게 아니라 타입으로 정보를 구분해서 처리한다. 그리고 타입으로 구분하므로 다양한 타입을 처리할 수 있다.      
___
<br/>
<br/>

## 2. 도메인의 계층
___
DNS 서버는 등록되어 있는 정보를 계층으로 구분해서 정리해 놓았다.           
ex) www.naver.com 이라고 하면       
DNS는 .을 기준으로 계층을 나눠서 저장해 놓는다.     

- com
- naver
- www      

위와 같이 계층으로 구분해서 저장해 놓는다. (위에 있을수록 상위 계층)    
com이 가장 높은 계층이다.
- 이러한 계층 하나 하나를 도메인이라고 한다.      
따라서 com이라는 도메인 아래에 naver라는 도메인 아래에 www라는 이름이 있는 것

com이라는 도메인을 저장하는 DNS 서버는 한 대이다.     
즉 다른 DNS 서버에 com이라는 도메인이 있으면 안된다.    

naver.com 이라는 도메인을 저장하는 DNS 서버도 하나다.   
다른 DNS 서버에 naver.com이라는 도메인이 있으면 안된다.     

하지만 com이라는 도메인을 담당하는 DNS 서버에 kr 이라는 도메인이 들어있을 수 있다.    

즉 하나의 도메인은 하나의 DNS 서버에 저장.    
DNS 서버는 여러 도메인을 저장할 수 있다.    
___
<br/>
<br/>

## 3. 담당 DNS 서버를 찾아 IP 주소를 가져온다.
___
위의 경우는 내가 DNS 서버 안에 도메인명에 대한 IP주소가 등록되어 있다는 전제로 설명했다. 만약에 없다면 응답메시지로 해당 도메인명에 대한 IP주소를 반환 못했을 것이다.    
### 만약에 조회 메시지를 받은 DNS 서버에 정보가 등록되어 있지 않다면 어떻게 이후에 DNS 서버가 작동할까?     
결론부터 말하면 정보를 뿌려서 해당 정보가 있는 DNS 서버를 찾는다.  
<br/>
### 그럼 DNS 서버는 등록한 정보를 어떻게 찾는 걸까?
- 여기서 중요한 것은 액세스 대상의 **웹 서버**가 어느 DNS 서버에 등록되어 있는 지를 찾아내는 방법이다.      

DNS 서버에 또 다른 DNS 서버를 등록할 수 있다.     
ex1) www.naver.com         
naver.com이 등록되어 있는 DNS 서버를 com이 등록되어 있는 DNS 서버에 등록하면 젤 상위 계층인 com이 등록되어 있는 DNS 서버 안에서만 찾으면 된다.        
그 안에 하위 도메인이 포함되어 있는 정보를 담고 있는 DNS 서버까지 저장되어 있기 때문이다.

ex2) lab.glasscom.com       
lab.glasscom.com이라는 도메인을 담당하는 DNS 서버를 glasscom.com을 담당하는 DNS 서버에 등록하고 glasscom.com을 담당하는 DNS 서버를 com을 담당하는 DNS 서버에 등록한다.      
그러면 젤 상위 계층인 com을 담당하는 DNS 서버만 찾으면 그 안에서 다 찾을 수 있다.     

- 하위 도메인의 DNS 서버를 상위 도메인의 DNS 서버에 등록하여 젤 상위 도메인에서 내려가면서 조회하는 식으로 한다.      

사실 com같은 젤 상위 계층 위에 root 도메인이 있다. 하지만 우리가 url에 직접 표기하지는 않지만 존재한다. 즉 항상 root 도메인부터 아래로 내려가면서 조사한다.             


root 도메인을 가지고 있는 DNS 서버를 인터넷에 존재하는 DNS 서버 모두에게 전부 등록해 놓았다. 그래서 모든 DNS 서버에서 root 도메인에 액세스할 수 있다.

- 이렇게 했을 때 좋은 점      
  클라이언트에서 가장 가까운 DNS 서버에 조회했을 때 없으면 해당 DNS 서버에서 root 도메인의 DNS 서버로 액세스 해서 다시 최상위 계층에서 내려가면서 원하는 도메인을 가지고 있는 DNS 서버를 찾을 수 있다.

ex) www.lab.glasscom.com 주소 찾는 순서     
1. 클라이언트에서 가장 가까운 DNS 서버(a)에 "www.lab.glasscom.com ip 주소 찾아주세요"  조회 메시지를 보낸다.
2. a에는 도메인이 없다. 그러면 해당 도메인의 루트 도메인에 똑같은 메시지를 보낸다.
3. 루트 도메인에는 해당 도메인이 당연 없다. 그러나 가장 가까운 com이라는 DNS 서버는 알고 있으니 "com이라는 DNS 서버에 가보세요" 하면서 com의 DNS 서버의 IP 주소를 응답 메시지로 a에 보낸다.
4. a는 다시 com의 DNS 서버에 "www.lab.glasscom.com의 ip 주소 찾아주세요" 조회 메시지를 보낸다.
5. com에도 해당 도메인은 없다. 하지만 가까운 glasscom.com DNS 서버는 알고 있다. 그래서 a에게 "glasscom.com DNS 서버로 가세요" 하면서 해당 도메인의 DNS 서버 IP 주소를 응답 메시지로 a에게 보낸다.
6. 다시 a는 glasscom.com DNS 서버에게 "www.lab.glasscom.com ip 주소 찾아주세요" 조회 메시지를 보낸다.
7. glasscom.com DNS 서버에도 없다. 하지만 가까운 lab.glasscom.com DNS 서버는 등록되어 있으므로 알고 있다. 그래서 응답 메시지로 "lab.glasscom.com DNS 서버로 가세요" 하면서 해당 도메인의 DNS 서버 ip 주소를 응답 메시지에 담아서 a에게 보낸다.
8. a는 lab.glasscom.com DNS 서버에 "www.lab.glasscom.com ip 주소 알려주세요" 조회 메시지를 보낸다.
9. lab.glasscom.com DNS 서버에는 있으므로 해당 www.lab.glasscom.com ip 주소를 a에게 보낸다.
10. a는 해당 응답 메시지를 클라이언트에게 보낸다.
11. 결국 클라이언트가 액세스 하고픈 웹 서버의 ip주소를 알아냈고 DNS 서버로부터 응답메시지를 받았으니 다시 os에 프로토콜 스택으로 응답을 보내고 리졸버로 간 다음 ip만 추출하여 애플리케이션 메모리에 저장되었다가 HTTP 리퀘스트 메시지와 웹 서버의 ip 주소를 가지고 os에게 리퀘스트 메시지를 웹 서버에게 보내달라고 한다.(해당 과정은 DNS 서버에서 웹 서버의 도메인명으로 ip 주소를 찾은 뒤의 이야기다. 해당 내용은 1.웹 브라우저가 메시지를 만든다 -2 에 정리해 놓았다.)

끝.
___
<br/>
<br/>

## 4. DNS 서버는 캐시 기능으로 빠르게 회답할 수 있다.
___
위에서의 예는 하나의 DNS 서버에 하나의 도메인만 저장할 수 있다는 가정하에 있다 실제로는 하나의 DNS 서버에 glasscom과 lab이 같이 있을 수도 있다. 이럴 때는 glasscom 찾고 lab도 같이 찾을 수 있어서 한 개의 과정을 뛰어넘을 수 있다.      
<br/>
DNS 서버에는 캐시가 있어서 한 번 조사한 도메인 이름을 기록할 수 있어서 만약 조회하고자 하는 도메인명이 DNS 서버에서 전에 한 번 조회했어서 캐시에 들어있다면 더 빠르게 응답 메시지를 보낸다.
<br/>   
해당 도메인명이 없다는 것도 캐시에 저장되어 있어서 DNS 서버에 없는 도메인명을 요청했는 데 저번에도 한 번 조회했는 데 없었던 적이 있었다면 없었다는 것을 캐시에 저장해 놨다가 해당 도메인명이 들어오면 없다고 바로 응답메시지를 보낼 수 있다.
<br/>     
하지만 캐시는 DNS 서버의 정보가 바꼇을 때 같이 바뀌지 않아 신뢰성이 조금 떨어진다. 그래서 캐시에 기한이 정해져 있어서 해당 기한이 지나면 캐시에서 삭제된다.
___